{{#if is_thinking_kind}}
<div class="sp-ai-reasoning" data-sp-ai-widget-version="{{version}}" data-sp-ai-status="{{status}}">
    <button class="sp-ai-reasoning-trigger" type="button" aria-expanded="{{reasoning_expanded}}">
        <svg class="sp-ai-reasoning-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"></path>
            <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"></path>
            <path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"></path>
            <path d="M17.599 6.5a3 3 0 0 0 .399-1.375"></path>
            <path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"></path>
            <path d="M3.477 10.896a4 4 0 0 1 .585-.396"></path>
            <path d="M19.938 10.5a4 4 0 0 1 .585.396"></path>
            <path d="M6 18a4 4 0 0 1-1.967-.516"></path>
            <path d="M19.967 17.484A4 4 0 0 1 18 18"></path>
        </svg>
        <span class="sp-ai-reasoning-label">{{reasoning_label}}</span>
        <svg class="sp-ai-reasoning-chevron" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m6 9 6 6 6-6"></path>
        </svg>
    </button>
    {{#if has_reasoning_text}}
    <div class="sp-ai-reasoning-content" aria-hidden="{{reasoning_content_hidden}}">
        <div class="sp-ai-reasoning-text">{{reasoning_text}}</div>
    </div>
    {{/if}}
</div>
{{else if is_tool_kind}}
<details
    class="sp-ai-tool sp-ai-widget sp-ai-kind-{{kind}}{{#if show_parallel}} sp-ai-parallel{{#if parallel_first}} sp-ai-parallel-first{{/if}}{{#if parallel_last}} sp-ai-parallel-last{{/if}}{{/if}}"
    data-sp-ai-widget-version="{{version}}"
    data-sp-ai-kind="{{kind}}"
    data-sp-ai-status="{{status}}"
    {{#if tool_open}}open{{/if}}
>
    {{#if show_parallel}}
        <div class="sp-ai-parallel-rail" aria-hidden="true"></div>
    {{/if}}

    <summary class="sp-ai-tool-summary">
        <div class="sp-ai-tool-summary-left">
            <span class="sp-ai-tool-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.7 6.3a5 5 0 0 0-6.4 6.4l-5.6 5.6a2 2 0 0 0 2.8 2.8l5.6-5.6a5 5 0 0 0 6.4-6.4l-3 3-2.8-2.8 3-3Z"></path>
                </svg>
            </span>

            <span class="sp-ai-tool-name">{{tool_title}}</span>

            <span class="sp-ai-tool-status sp-ai-status-{{status}}">
                <span class="sp-ai-tool-status-icon sp-ai-tool-status-icon-pending" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                    </svg>
                </span>
                <span class="sp-ai-tool-status-icon sp-ai-tool-status-icon-running" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                </span>
                <span class="sp-ai-tool-status-icon sp-ai-tool-status-icon-approval-requested" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                </span>
                <span class="sp-ai-tool-status-icon sp-ai-tool-status-icon-approval-responded" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 6 9 17l-5-5"></path>
                    </svg>
                </span>
                <span class="sp-ai-tool-status-icon sp-ai-tool-status-icon-ok" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 6 9 17l-5-5"></path>
                    </svg>
                </span>
                <span class="sp-ai-tool-status-icon sp-ai-tool-status-icon-error" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18"></path>
                        <path d="M6 6 18 18"></path>
                    </svg>
                </span>
                <span class="sp-ai-tool-status-icon sp-ai-tool-status-icon-aborted" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M15 9 9 15"></path>
                        <path d="M9 9 15 15"></path>
                    </svg>
                </span>
                <span class="sp-ai-tool-status-icon sp-ai-tool-status-icon-denied" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M4.9 4.9 19.1 19.1"></path>
                    </svg>
                </span>

                <span class="sp-ai-tool-status-text">{{tool_status_label}}</span>
            </span>
        </div>

        <div class="sp-ai-tool-summary-right">
            <span class="sp-ai-tool-chevron" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m6 9 6 6 6-6"></path>
                </svg>
            </span>
        </div>
    </summary>

    <div class="sp-ai-tool-content">
        {{#if show_caption}}
            <div class="sp-ai-caption">{{caption}}</div>
        {{/if}}

        {{#if has_args_block}}
            <div class="sp-ai-tool-section sp-ai-panel-section sp-ai-panel-section-first">
                <div class="sp-ai-tool-section-header">
                    <h4 class="sp-ai-tool-section-title">{{args_block_title}}</h4>
                    <button class="sp-ai-icon-btn sp-ai-icon-btn-copy" type="button" data-copy-block="{{args_block_index}}" aria-label="Copy">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
                <div class="sp-ai-tool-codewrap">
                    <pre class="sp-ai-tool-code" data-language="{{args_block_language}}">{{args_block_text}}</pre>
                </div>
            </div>
        {{/if}}

        {{#if has_tool_stream_preview}}
            <div class="sp-ai-tool-stream-preview">
                <div class="sp-ai-tool-section-header">
                    <h4 class="sp-ai-tool-section-title">{{tool_stream_preview_title}}</h4>
                </div>
                <div class="sp-ai-output-toggle" data-sp-ai-output-toggle>
                    <pre class="sp-ai-output-toggle-pre">{{tool_stream_preview_tail}}</pre>
                    {{#if has_tool_stream_more}}
                        <div class="sp-ai-output-toggle-actions">
                            <button class="sp-ai-output-toggle-btn" type="button" data-sp-ai-toggle-output>
                                <span class="sp-ai-output-toggle-more-label">{{tool_stream_more_label}}</span>
                                <span class="sp-ai-output-toggle-less-label">Less</span>
                            </button>
                        </div>
                        <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-tail" hidden>{{tool_stream_preview_tail}}</pre>
                        <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-full" hidden>{{tool_stream_preview_text}}</pre>
                    {{/if}}
                </div>
            </div>
        {{/if}}

        {{#if has_background_tasks}}
            <details class="sp-ai-section sp-ai-background-tasks-section" open>
                <summary>
                    <h4 class="sp-ai-tool-section-title">{{background_tasks_section_title}}</h4>
                </summary>

                <div class="sp-ai-background-task-groups">
                    {{#each background_task_groups}}
                        {{#if title}}
                            <div class="sp-ai-background-task-group-title">{{title}}</div>
                        {{/if}}

                        <ul class="sp-ai-background-task-list">
                            {{#each tasks}}
                                <li class="sp-ai-background-task">
                                    <div class="sp-ai-background-task-main">
                                        {{#if command}}
                                            <div class="sp-ai-background-task-command">{{command}}</div>
                                        {{/if}}

                                        {{#if description}}
                                            <div class="sp-ai-background-task-desc">{{description}}</div>
                                        {{/if}}

                                        {{#if meta_line}}
                                            <div class="sp-ai-background-task-meta">{{meta_line}}</div>
                                        {{/if}}

                                        {{#if error}}
                                            <div class="sp-ai-background-task-error">{{error}}</div>
                                        {{/if}}

                                        {{#if has_output_preview}}
                                            <div class="sp-ai-output-toggle" data-sp-ai-output-toggle>
                                                <pre class="sp-ai-output-toggle-pre">{{output_preview_tail}}</pre>
                                                {{#if has_output_more}}
                                                    <div class="sp-ai-output-toggle-actions">
                                                        <button class="sp-ai-output-toggle-btn" type="button" data-sp-ai-toggle-output>
                                                            <span class="sp-ai-output-toggle-more-label">{{output_preview_more_label}}</span>
                                                            <span class="sp-ai-output-toggle-less-label">Less</span>
                                                        </button>
                                                    </div>
                                                    <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-tail" hidden>{{output_preview_tail}}</pre>
                                                    <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-full" hidden>{{output_preview}}</pre>
                                                {{/if}}
                                            </div>
                                        {{/if}}
                                    </div>

                                    <button
                                        class="sp-ai-icon-btn sp-ai-icon-btn-copy"
                                        type="button"
                                        data-copy-bg-task-command="{{../group_index}}:{{task_index}}"
                                        aria-label="Copy command"
                                    >
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                    </button>

                                    <span class="sp-ai-background-task-status sp-ai-background-task-status-{{status}}">{{status_label}}</span>
                                </li>
                            {{/each}}
                        </ul>
                    {{/each}}
                </div>
            </details>
        {{/if}}

        {{#if has_plan_blocks}}
            <details class="sp-ai-section sp-ai-plan-section" open>
                <summary>
                    <h4 class="sp-ai-tool-section-title">{{plan_section_title}}</h4>
                </summary>

                <div class="sp-ai-plan-groups">
                    {{#each plan_groups}}
                        {{#if title}}
                            <div class="sp-ai-plan-group-title">{{title}}</div>
                        {{/if}}

                        <ol class="sp-ai-plan-list">
                            {{#each steps}}
                                <li class="sp-ai-plan-step">
                                    <span class="sp-ai-plan-step-status sp-ai-plan-step-status-{{status}}">{{status_label}}</span>
                                    <div class="sp-ai-plan-step-text">{{step}}</div>
                                </li>
                            {{/each}}
                        </ol>
                    {{/each}}
                </div>
            </details>
        {{/if}}

        {{#if has_todo_blocks}}
            <details class="sp-ai-section sp-ai-todo-section" open>
                <summary>
                    <h4 class="sp-ai-tool-section-title">{{todo_section_title}}</h4>
                </summary>

                <div class="sp-ai-todo-groups">
                    {{#each todo_groups}}
                        {{#if title}}
                            <div class="sp-ai-todo-group-title">{{title}}</div>
                        {{/if}}

                        <ul class="sp-ai-todo-list">
                            {{#each items}}
                                <li class="sp-ai-todo-item {{#if checked}}sp-ai-todo-item-checked{{/if}}">
                                    <span class="sp-ai-todo-checkbox" aria-hidden="true">
                                        {{#if checked}}
                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20 6 9 17l-5-5"></path>
                                            </svg>
                                        {{else}}
                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                                            </svg>
                                        {{/if}}
                                    </span>
                                    <span class="sp-ai-todo-text">{{text}}</span>
                                </li>
                            {{/each}}
                        </ul>
                    {{/each}}
                </div>
            </details>
        {{/if}}

        {{#if has_blocks}}
            <div class="sp-ai-tool-sections">
                {{#each blocks}}
                    <section class="sp-ai-tool-section sp-ai-block-{{kind}}{{#if is_stream}} sp-ai-tool-section-stream sp-ai-tool-section-stream-{{channel}}{{/if}}{{#if is_unknown}} sp-ai-tool-section-unknown{{/if}}">
                        <div class="sp-ai-tool-section-header">
                            <h4 class="sp-ai-tool-section-title">{{#if title}}{{title}}{{else}}{{label}}{{/if}}</h4>
                            <button class="sp-ai-icon-btn sp-ai-icon-btn-copy" type="button" data-copy-block="{{index}}" aria-label="Copy">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>

                        {{#if is_table}}
                            <div class="sp-ai-table-wrap">
                                <table class="sp-ai-table">
                                    {{#if has_columns}}
                                        <thead>
                                            <tr>
                                                {{#each columns}}
                                                    <th>{{this}}</th>
                                                {{/each}}
                                            </tr>
                                        </thead>
                                    {{/if}}
                                    <tbody>
                                        {{#each rows}}
                                            <tr>
                                                {{#each this}}
                                                    <td>{{this}}</td>
                                                {{/each}}
                                            </tr>
                                        {{/each}}
                                    </tbody>
                                </table>
                            </div>
                        {{else if is_context_usage}}
                            <div class="sp-ai-context-usage">
                                {{#if has_context_usage_percent}}
                                    <div class="sp-ai-context-usage-bar" role="progressbar" aria-valuenow="{{context_usage_percent}}" aria-valuemin="0" aria-valuemax="100">
                                        <div class="sp-ai-context-usage-bar-fill" style="width: {{context_usage_percent}}%;"></div>
                                    </div>
                                {{/if}}

                                {{#if text}}
                                    <div class="sp-ai-context-usage-summary">{{text}}</div>
                                {{/if}}

                                {{#if has_list_items}}
                                    <ul class="sp-ai-block-list">
                                        {{#each list_items}}
                                            <li class="sp-ai-block-list-item">{{this}}</li>
                                        {{/each}}
                                    </ul>
                                {{/if}}
                            </div>
                        {{else if has_list_items}}
                            {{#if is_file_tree}}
                                <div class="sp-ai-tool-codewrap">
                                    <pre class="sp-ai-tool-code" data-language="">{{text}}</pre>
                                </div>
                            {{else}}
                                <ul class="sp-ai-block-list">
                                    {{#each list_items}}
                                        <li class="sp-ai-block-list-item">{{this}}</li>
                                    {{/each}}
                                </ul>
                            {{/if}}
                        {{else}}
                            {{#if is_markdown}}
                                <div class="sp-ai-markdown rendered_markdown">{{{markdown_html}}}</div>
                            {{else}}
                                <div class="sp-ai-tool-codewrap">
                                    <pre class="sp-ai-tool-code" data-language="{{language}}">{{text}}</pre>
                                </div>
                            {{/if}}
                        {{/if}}
                    </section>
                {{/each}}
            </div>
        {{else}}
            {{#if (eq has_input true)}}
                <div class="sp-ai-tool-section">
                    <div class="sp-ai-tool-section-header">
                        <h4 class="sp-ai-tool-section-title">Parameters</h4>
                        <button class="sp-ai-icon-btn sp-ai-icon-btn-copy" type="button" data-copy="input" aria-label="Copy">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="sp-ai-tool-codewrap">
                        <pre class="sp-ai-tool-code" data-language="json">{{input}}</pre>
                    </div>
                </div>
            {{/if}}

            {{#if (eq has_output true)}}
                <div class="sp-ai-tool-section">
                    <div class="sp-ai-tool-section-header">
                        <h4 class="sp-ai-tool-section-title">Output</h4>
                        <button class="sp-ai-icon-btn sp-ai-icon-btn-copy" type="button" data-copy="output" aria-label="Copy">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="sp-ai-tool-codewrap">
                        <pre class="sp-ai-tool-code" data-language="">{{output}}</pre>
                    </div>
                </div>
            {{/if}}
        {{/if}}

        {{#if show_tool_approval_actions}}
            <div class="sp-ai-footer sp-ai-tool-footer">
                <button class="sp-ai-btn sp-ai-btn-approve" type="button" data-action="approve">Approve</button>
                <button class="sp-ai-btn sp-ai-btn-deny" type="button" data-action="deny">Deny</button>
            </div>
        {{/if}}
    </div>
</details>
{{else}}
<div
    class="sp-ai-widget sp-ai-kind-{{kind}}{{#if show_parallel}} sp-ai-parallel{{#if parallel_first}} sp-ai-parallel-first{{/if}}{{#if parallel_last}} sp-ai-parallel-last{{/if}}{{/if}}"
    data-sp-ai-widget-version="{{version}}"
>
    {{#if show_parallel}}
        <div class="sp-ai-parallel-rail" aria-hidden="true"></div>
    {{/if}}

    <div class="sp-ai-header">
        <div class="sp-ai-title-wrap">
            <div class="sp-ai-title">{{title}}</div>
            {{#if show_kind_badge}}
                <div class="sp-ai-kind-badge">{{kind_label}}</div>
            {{/if}}
            {{#if show_status_pill}}
                <div class="sp-ai-status sp-ai-status-{{status}}">{{status_label}}</div>
            {{/if}}
        </div>
    </div>

    {{#if show_caption}}
        <div class="sp-ai-caption">{{caption}}</div>
    {{/if}}

    {{#if show_tool}}
        <div class="sp-ai-meta">
            <span class="sp-ai-meta-key">Tool</span>
            <span class="sp-ai-meta-val">{{tool}}</span>
        </div>
    {{/if}}

    {{#if has_subagent_groups}}
        {{#if is_subagent_group_card}}
            <div class="sp-ai-subagent-groups">
                {{#each subagent_groups}}
                    {{#if has_agents}}
                        <ul class="sp-ai-subagent-list">
                            {{#each agents}}
                                <li class="sp-ai-subagent">
                                    <div class="sp-ai-subagent-main">
                                        <div class="sp-ai-subagent-head">
                                            <span class="sp-ai-subagent-type">{{type}}</span>
                                            <span class="sp-ai-subagent-desc">{{description}}</span>
                                        </div>

                                        {{#if has_output_preview}}
                                            <div class="sp-ai-output-toggle" data-sp-ai-output-toggle>
                                                <pre class="sp-ai-output-toggle-pre">{{output_preview_tail}}</pre>
                                                {{#if has_output_more}}
                                                    <div class="sp-ai-output-toggle-actions">
                                                        <button class="sp-ai-output-toggle-btn" type="button" data-sp-ai-toggle-output>
                                                            <span class="sp-ai-output-toggle-more-label">{{output_preview_more_label}}</span>
                                                            <span class="sp-ai-output-toggle-less-label">Less</span>
                                                        </button>
                                                    </div>
                                                    <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-tail" hidden>{{output_preview_tail}}</pre>
                                                    <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-full" hidden>{{output_preview}}</pre>
                                                {{/if}}
                                            </div>
                                        {{/if}}

                                        {{#if meta_line}}
                                            <div class="sp-ai-subagent-meta">{{meta_line}}</div>
                                        {{/if}}

                                        {{#if error}}
                                            <div class="sp-ai-subagent-error">{{error}}</div>
                                        {{/if}}
                                    </div>

                                    <div class="sp-ai-subagent-right">
                                        <span class="sp-ai-subagent-status sp-ai-subagent-status-{{status}}">{{status_label}}</span>
                                        {{#if agentURL}}
                                            <a class="sp-ai-subagent-link" href="{{agentURL}}" target="_blank" rel="noopener noreferrer">Open</a>
                                        {{/if}}
                                    </div>
                                </li>
                            {{/each}}
                        </ul>
                    {{else}}
                        {{#if fallback_text}}
                            <pre class="sp-ai-pre">{{fallback_text}}</pre>
                        {{/if}}
                    {{/if}}
                {{/each}}
            </div>
        {{else}}
            <details class="sp-ai-section sp-ai-subagent-section" open>
                <summary>
                    <span>{{subagent_section_title}}</span>
                </summary>

                <div class="sp-ai-subagent-groups">
                    {{#each subagent_groups}}
                        {{#if title}}
                            <div class="sp-ai-subagent-group-title">{{title}}</div>
                        {{/if}}

                        {{#if has_agents}}
                            <ul class="sp-ai-subagent-list">
                                {{#each agents}}
                                    <li class="sp-ai-subagent">
                                        <div class="sp-ai-subagent-main">
                                            <div class="sp-ai-subagent-head">
                                                <span class="sp-ai-subagent-type">{{type}}</span>
                                                <span class="sp-ai-subagent-desc">{{description}}</span>
                                            </div>

                                            {{#if has_output_preview}}
                                                <div class="sp-ai-output-toggle" data-sp-ai-output-toggle>
                                                    <pre class="sp-ai-output-toggle-pre">{{output_preview_tail}}</pre>
                                                    {{#if has_output_more}}
                                                        <div class="sp-ai-output-toggle-actions">
                                                            <button class="sp-ai-output-toggle-btn" type="button" data-sp-ai-toggle-output>
                                                                <span class="sp-ai-output-toggle-more-label">{{output_preview_more_label}}</span>
                                                                <span class="sp-ai-output-toggle-less-label">Less</span>
                                                            </button>
                                                        </div>
                                                        <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-tail" hidden>{{output_preview_tail}}</pre>
                                                        <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-full" hidden>{{output_preview}}</pre>
                                                    {{/if}}
                                                </div>
                                            {{/if}}

                                            {{#if meta_line}}
                                                <div class="sp-ai-subagent-meta">{{meta_line}}</div>
                                            {{/if}}

                                            {{#if error}}
                                                <div class="sp-ai-subagent-error">{{error}}</div>
                                            {{/if}}
                                        </div>

                                        <div class="sp-ai-subagent-right">
                                            <span class="sp-ai-subagent-status sp-ai-subagent-status-{{status}}">{{status_label}}</span>
                                            {{#if agentURL}}
                                                <a class="sp-ai-subagent-link" href="{{agentURL}}" target="_blank" rel="noopener noreferrer">Open</a>
                                            {{/if}}
                                        </div>
                                    </li>
                                {{/each}}
                            </ul>
                        {{else}}
                            {{#if fallback_text}}
                                <pre class="sp-ai-pre">{{fallback_text}}</pre>
                            {{/if}}
                        {{/if}}
                    {{/each}}
                </div>
            </details>
        {{/if}}
    {{/if}}

    {{#if has_background_tasks}}
        <details class="sp-ai-section sp-ai-background-tasks-section" open>
            <summary>
                <h4 class="sp-ai-tool-section-title">{{background_tasks_section_title}}</h4>
            </summary>

            <div class="sp-ai-background-task-groups">
                {{#each background_task_groups}}
                    {{#if title}}
                        <div class="sp-ai-background-task-group-title">{{title}}</div>
                    {{/if}}

                    <ul class="sp-ai-background-task-list">
                        {{#each tasks}}
                            <li class="sp-ai-background-task">
                                <div class="sp-ai-background-task-main">
                                    {{#if command}}
                                        <div class="sp-ai-background-task-command">{{command}}</div>
                                    {{/if}}

                                    {{#if description}}
                                        <div class="sp-ai-background-task-desc">{{description}}</div>
                                    {{/if}}

                                    {{#if meta_line}}
                                        <div class="sp-ai-background-task-meta">{{meta_line}}</div>
                                    {{/if}}

                                    {{#if error}}
                                        <div class="sp-ai-background-task-error">{{error}}</div>
                                    {{/if}}

                                    {{#if has_output_preview}}
                                        <div class="sp-ai-output-toggle" data-sp-ai-output-toggle>
                                            <pre class="sp-ai-output-toggle-pre">{{output_preview_tail}}</pre>
                                            {{#if has_output_more}}
                                                <div class="sp-ai-output-toggle-actions">
                                                    <button class="sp-ai-output-toggle-btn" type="button" data-sp-ai-toggle-output>
                                                        <span class="sp-ai-output-toggle-more-label">{{output_preview_more_label}}</span>
                                                        <span class="sp-ai-output-toggle-less-label">Less</span>
                                                    </button>
                                                </div>
                                                <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-tail" hidden>{{output_preview_tail}}</pre>
                                                <pre class="sp-ai-output-toggle-data sp-ai-output-toggle-data-full" hidden>{{output_preview}}</pre>
                                            {{/if}}
                                        </div>
                                    {{/if}}
                                </div>

                                <button
                                    class="sp-ai-icon-btn sp-ai-icon-btn-copy"
                                    type="button"
                                    data-copy-bg-task-command="{{../group_index}}:{{task_index}}"
                                    aria-label="Copy command"
                                >
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>

                                <span class="sp-ai-background-task-status sp-ai-background-task-status-{{status}}">{{status_label}}</span>
                            </li>
                        {{/each}}
                    </ul>
                {{/each}}
            </div>
        </details>
    {{/if}}

    {{#if has_plan_blocks}}
        <details class="sp-ai-section sp-ai-plan-section" open>
            <summary>
                <h4 class="sp-ai-tool-section-title">{{plan_section_title}}</h4>
            </summary>

            <div class="sp-ai-plan-groups">
                {{#each plan_groups}}
                    {{#if title}}
                        <div class="sp-ai-plan-group-title">{{title}}</div>
                    {{/if}}

                    <ol class="sp-ai-plan-list">
                        {{#each steps}}
                            <li class="sp-ai-plan-step">
                                <span class="sp-ai-plan-step-status sp-ai-plan-step-status-{{status}}">{{status_label}}</span>
                                <div class="sp-ai-plan-step-text">{{step}}</div>
                            </li>
                        {{/each}}
                    </ol>
                {{/each}}
            </div>
        </details>
    {{/if}}

    {{#if has_todo_blocks}}
        <details class="sp-ai-section sp-ai-todo-section" open>
            <summary>
                <h4 class="sp-ai-tool-section-title">{{todo_section_title}}</h4>
            </summary>

            <div class="sp-ai-todo-groups">
                {{#each todo_groups}}
                    {{#if title}}
                        <div class="sp-ai-todo-group-title">{{title}}</div>
                    {{/if}}

                    <ul class="sp-ai-todo-list">
                        {{#each items}}
                            <li class="sp-ai-todo-item {{#if checked}}sp-ai-todo-item-checked{{/if}}">
                                <span class="sp-ai-todo-checkbox" aria-hidden="true">
                                    {{#if checked}}
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M20 6 9 17l-5-5"></path>
                                        </svg>
                                    {{else}}
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                                        </svg>
                                    {{/if}}
                                </span>
                                <span class="sp-ai-todo-text">{{text}}</span>
                            </li>
                        {{/each}}
                    </ul>
                {{/each}}
            </div>
        </details>
    {{/if}}

    {{#if (eq has_input true)}}
        <div class="sp-ai-tool-section sp-ai-panel-section">
            <div class="sp-ai-tool-section-header">
                <h4 class="sp-ai-tool-section-title">Input</h4>
                <button class="sp-ai-icon-btn sp-ai-icon-btn-copy" type="button" data-copy="input" aria-label="Copy">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            </div>
            <div class="sp-ai-tool-codewrap">
                <pre class="sp-ai-tool-code" data-language="">{{input}}</pre>
            </div>
        </div>
    {{/if}}

    {{#if (eq has_output true)}}
        <div class="sp-ai-tool-section sp-ai-panel-section">
            <div class="sp-ai-tool-section-header">
                <h4 class="sp-ai-tool-section-title">Output</h4>
                <button class="sp-ai-icon-btn sp-ai-icon-btn-copy" type="button" data-copy="output" aria-label="Copy">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            </div>
            <div class="sp-ai-tool-codewrap">
                <pre class="sp-ai-tool-code" data-language="">{{output}}</pre>
            </div>
        </div>
    {{/if}}

    {{#if has_blocks}}
        <div class="sp-ai-blocks">
            {{#each blocks}}
                <section class="sp-ai-block sp-ai-block-{{kind}}{{#if is_unknown}} sp-ai-block-unknown{{/if}}{{#if is_stream}} sp-ai-block-stream sp-ai-block-stream-{{channel}}{{/if}}">
                    <div class="sp-ai-block-header">
                        <div class="sp-ai-block-meta">
                            <span class="sp-ai-block-badge">{{label}}</span>
                            {{#if title}}
                                {{#unless (eq title label)}}
                                    <span class="sp-ai-block-title">{{title}}</span>
                                {{/unless}}
                            {{/if}}
                        </div>

                        <button class="sp-ai-icon-btn sp-ai-icon-btn-copy" type="button" data-copy-block="{{index}}" aria-label="Copy">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>

                    {{#if is_table}}
                        <div class="sp-ai-table-wrap">
                            <table class="sp-ai-table">
                                {{#if has_columns}}
                                    <thead>
                                        <tr>
                                            {{#each columns}}
                                                <th>{{this}}</th>
                                            {{/each}}
                                        </tr>
                                    </thead>
                                {{/if}}
                                <tbody>
                                    {{#each rows}}
                                        <tr>
                                            {{#each this}}
                                                <td>{{this}}</td>
                                            {{/each}}
                                        </tr>
                                    {{/each}}
                                </tbody>
                            </table>
                        </div>
                    {{else if is_context_usage}}
                        <div class="sp-ai-context-usage">
                            {{#if has_context_usage_percent}}
                                <div class="sp-ai-context-usage-bar" role="progressbar" aria-valuenow="{{context_usage_percent}}" aria-valuemin="0" aria-valuemax="100">
                                    <div class="sp-ai-context-usage-bar-fill" style="width: {{context_usage_percent}}%;"></div>
                                </div>
                            {{/if}}

                            {{#if text}}
                                <div class="sp-ai-context-usage-summary">{{text}}</div>
                            {{/if}}

                            {{#if has_list_items}}
                                <ul class="sp-ai-block-list">
                                    {{#each list_items}}
                                        <li class="sp-ai-block-list-item">{{this}}</li>
                                    {{/each}}
                                </ul>
                            {{/if}}
                        </div>
                    {{else if has_list_items}}
                        {{#if is_file_tree}}
                            <pre class="sp-ai-pre" data-language="">{{text}}</pre>
                        {{else}}
                            <ul class="sp-ai-block-list">
                                {{#each list_items}}
                                    <li class="sp-ai-block-list-item">{{this}}</li>
                                {{/each}}
                            </ul>
                        {{/if}}
                    {{else}}
                        {{#if is_markdown}}
                            <div class="sp-ai-markdown rendered_markdown">{{{markdown_html}}}</div>
                        {{else}}
                            <pre class="sp-ai-pre{{#if language}} sp-ai-pre-lang{{/if}}" data-language="{{language}}">{{text}}</pre>
                        {{/if}}
                    {{/if}}
                </section>
            {{/each}}
        </div>
    {{/if}}

    {{#if has_widget_actions}}
        <div class="sp-ai-footer">
            {{#if show_abort}}
                <button class="sp-ai-btn sp-ai-btn-abort" type="button" data-action="abort">Abort</button>
            {{/if}}

            {{#if show_retry}}
                <button class="sp-ai-btn sp-ai-btn-retry" type="button" data-action="retry">Retry</button>
            {{/if}}

            {{#if show_approve}}
                <button class="sp-ai-btn sp-ai-btn-approve" type="button" data-action="approve">Approve</button>
            {{/if}}

            {{#if show_deny}}
                <button class="sp-ai-btn sp-ai-btn-deny" type="button" data-action="deny">Deny</button>
            {{/if}}
        </div>
    {{/if}}
</div>
{{/if}}
