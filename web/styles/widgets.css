.widget-content {
    margin-bottom: var(--markdown-interelement-space-px);
}

.widget-choices {
    & ul {
        padding: 3px;
    }

    & li {
        padding: 2px;
        list-style: none;
    }

    & button {
        font-weight: 700;
        color: hsl(240deg 100% 50%);
    }

    .widget-choices-heading {
        font-weight: 600;
    }

}

/* Shared card primitives for non-sp_ai widgets (poll/todo/zform), aligned to sp_ai. */
.sp-widget-card {
    /* Compact card language shared across poll/todo/zform.
       Keep click targets reasonable, but tighter than Zulip defaults. */
    --sp-card-bg: var(--color-background-widget-button);
    --sp-card-border: var(--color-border-dropdown-widget-button);
    --sp-widget-leading-size: 32px;
    --sp-widget-row-height: 32px;

    border: 1px solid var(--sp-card-border);
    background-color: var(--sp-card-bg);
    border-radius: 10px;
    padding: 8px 10px;
    max-width: 100%;
}

.sp-widget-header {
    display: flex;
    flex-flow: row wrap;
    align-items: baseline;
    justify-content: space-between;
    gap: 5px;
}

.sp-widget-title-wrap {
    display: flex;
    flex-flow: row wrap;
    align-items: center;
    gap: 6px;
    flex: 1 1 auto;
    min-width: 12ch;
}

.sp-widget-title-line {
    display: flex;
    flex-flow: row wrap;
    align-items: center;
    gap: 6px;
    min-width: 0;
}

.sp-widget-pills {
    display: flex;
    flex-flow: row wrap;
    align-items: center;
    gap: 3px;
}

.sp-widget-title {
    font-size: 1.0714em; /* 15px at 14px/em */
    font-weight: 600;
    margin: 0;
    overflow-wrap: anywhere;
}

/* Ensure global h4 styles don't reintroduce bottom margin inside widget cards. */
.sp-widget-card h4.sp-widget-title {
    margin: 0;
}

.sp-widget-pill {
    flex: 0 0 auto;
    font-size: 0.7857em; /* 11px at 14px/em */
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 999px;
    border: 1px solid var(--color-border-zulip-button);
    background-color: var(--color-background-zulip-button);
}

.sp-widget-icon-btn {
    flex: 0 0 auto;
    width: 26px;
    height: 26px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border-dropdown-widget-button);
    border-radius: 8px;
    background-color: transparent;
    color: var(--color-text-default);
    opacity: 0.65;
    cursor: pointer;

    &:hover {
        opacity: 0.9;
        background-color: color-mix(in srgb, var(--color-background-widget-button) 55%, transparent);
    }

    &:active {
        transform: translateY(0.5px);
    }
}

/* ZForm choices widget (card style). */
.widget-choices.sp-widget-card {
    & .sp-widget-choice-list {
        margin: 8px 0 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    & .sp-widget-choice {
        list-style: none;
        padding: 0;
        display: flex;
        flex-flow: row wrap;
        align-items: center;
        gap: 8px;
    }

    & .sp-widget-choice-btn {
        flex: 0 0 auto;
        width: var(--sp-widget-leading-size);
        height: var(--sp-widget-leading-size);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--color-border-dropdown-widget-button);
        border-radius: 8px;
        padding: 0;
        background-color: var(--color-background-widget-button);
        color: var(--color-text-default);
        font-weight: 800;
        font-size: 0.857em;
        line-height: 1;
        cursor: pointer;

        &:hover {
            filter: brightness(0.98);
        }

        &:active {
            transform: translateY(0.5px);
        }
    }

    & .sp-widget-choice-label {
        flex: 1 1 auto;
        min-width: 16ch;
        opacity: 0.8;
        line-height: 1.4;
    }
}

/* Poll/Todo widgets: unify list row styling with zform choices. */
.sp-widget-card.poll-widget ul.poll-widget,
.sp-widget-card.todo-widget ul.todo-widget {
    margin: 8px 0 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.sp-widget-card.poll-widget ul.poll-widget > li,
.sp-widget-card.todo-widget ul.todo-widget > li {
    list-style: none;
    margin: 0;
    padding: 0;
}

.sp-widget-card.poll-widget .poll-option-label,
.sp-widget-card.todo-widget label.checkbox {
    display: flex;
    flex-flow: row wrap;
    align-items: center;
    gap: 8px;
}

/* Leading control (poll vote count) */
.sp-widget-card.poll-widget .poll-vote {
    width: var(--sp-widget-leading-size);
    height: var(--sp-widget-leading-size);
    min-width: var(--sp-widget-leading-size);
    border: 1px solid var(--color-border-dropdown-widget-button);
    border-radius: 8px;
    background-color: var(--color-background-widget-button);
    color: var(--color-text-default);
    font-weight: 800;
    font-size: 0.857em;
    line-height: 1;

    &:hover {
        filter: brightness(0.98);
    }

    &:focus {
        outline: 0;
    }

    &:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
}

.sp-widget-card.poll-widget .current-user-vote {
    background-color: color-mix(in srgb, #22c55e 10%, var(--color-background-widget-button));
    border-color: color-mix(in srgb, #22c55e 35%, var(--color-border-dropdown-widget-button));
    color: color-mix(in srgb, #22c55e 70%, var(--color-text-default));
}

.sp-widget-card.poll-widget .poll-option-text {
    font-weight: 600;
}

.sp-widget-card.poll-widget .poll-names {
    opacity: 0.75;
}

/* Leading control (todo checkbox) */
.sp-widget-card.todo-widget label.checkbox {
    /* Override legacy baseline alignment. */
    align-items: center;
}

.sp-widget-card.todo-widget .todo-checkbox {
    flex: 0 0 var(--sp-widget-leading-size);
    width: var(--sp-widget-leading-size);
    height: var(--sp-widget-leading-size);
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.sp-widget-card.todo-widget label.checkbox input[type="checkbox"] ~ .custom-checkbox {
    width: 20px;
    height: 20px;
    padding: 0;
    margin: 0;
    border: 2px solid var(--color-border-dropdown-widget-button);
    border-radius: 6px;
    background-color: transparent;
    background-image: none;
    background-repeat: no-repeat;
    background-position: 50% 50%;
    background-size: 75%;
}

.sp-widget-card.todo-widget label.checkbox input[type="checkbox"]:checked ~ .custom-checkbox {
    background-image: url("../images/checkbox-white.svg");
    background-color: color-mix(in srgb, #22c55e 12%, var(--color-background-widget-button));
    border-color: color-mix(in srgb, #22c55e 35%, var(--color-border-dropdown-widget-button));
}

.sp-widget-card.todo-widget label.checkbox input[type="checkbox"]:not(:checked):hover ~ .custom-checkbox {
    background-color: color-mix(in srgb, var(--color-background-widget-button) 80%, #fff);
}

.sp-ai-widget {
    --sp-ai-bg: var(--color-background-widget-button);
    --sp-ai-border: var(--color-border-dropdown-widget-button);
    --sp-ai-pad-y: 9px;

    border: 1px solid var(--sp-ai-border);
    background-color: var(--sp-ai-bg);
    border-radius: 6px;
    padding: var(--sp-ai-pad-y);
    max-width: 100%;
    position: relative;

    .sp-ai-parallel-rail {
        display: none;
    }

    /* Linked/parallel chain styling (inside the container).
       Requirements:
       - Bands are transparent so the message background shows through.
       - Stripes match the widget bg exactly.
    */
    &.sp-ai-parallel {
        --sp-ai-link-band: 12px;
        --sp-ai-link-top: 0px;
        --sp-ai-link-bottom: 0px;
        --sp-ai-link-top-stripe: transparent;
        --sp-ai-link-bottom-stripe: transparent;

        /* Side borders should not extend into the transparent transition bands. */
        border-left-color: transparent;
        border-right-color: transparent;

        background-color: transparent;
        background-repeat: no-repeat;
        background-image:
            /* Main widget fill, with transparent top/bottom transition bands. */
            linear-gradient(
                to bottom,
                transparent 0 var(--sp-ai-link-top),
                var(--sp-ai-bg) var(--sp-ai-link-top) calc(100% - var(--sp-ai-link-bottom)),
                transparent calc(100% - var(--sp-ai-link-bottom)) 100%
            ),
            /* Two thin stripes inside the top transition band (if present). */
            linear-gradient(var(--sp-ai-link-top-stripe) 0 0),
            linear-gradient(var(--sp-ai-link-top-stripe) 0 0),
            /* Two thin stripes inside the bottom transition band (if present). */
            linear-gradient(var(--sp-ai-link-bottom-stripe) 0 0),
            linear-gradient(var(--sp-ai-link-bottom-stripe) 0 0),
            /* Side borders only across the middle (non-transition) area. */
            linear-gradient(var(--sp-ai-border) 0 0),
            linear-gradient(var(--sp-ai-border) 0 0);
        background-size:
            100% 100%,
            100% 2px,
            100% 2px,
            100% 2px,
            100% 2px,
            1px calc(100% - var(--sp-ai-link-top) - var(--sp-ai-link-bottom)),
            1px calc(100% - var(--sp-ai-link-top) - var(--sp-ai-link-bottom));
        background-position:
            0 0,
            0 4px,
            0 8px,
            0 calc(100% - 8px),
            0 calc(100% - 4px),
            0 var(--sp-ai-link-top),
            100% var(--sp-ai-link-top);
    }

    &.sp-ai-parallel:not(.sp-ai-parallel-first) {
        --sp-ai-link-top: var(--sp-ai-link-band);
        --sp-ai-link-top-stripe: var(--sp-ai-bg);

        border-top-color: transparent;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        padding-top: calc(var(--sp-ai-pad-y) + var(--sp-ai-link-band));
    }

    &.sp-ai-parallel:not(.sp-ai-parallel-last) {
        --sp-ai-link-bottom: var(--sp-ai-link-band);
        --sp-ai-link-bottom-stripe: var(--sp-ai-bg);

        border-bottom-color: transparent;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        padding-bottom: calc(var(--sp-ai-pad-y) + var(--sp-ai-link-band));
    }

    .sp-ai-header {
        display: flex;
        flex-flow: row wrap;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
    }

    .sp-ai-title-wrap {
        display: flex;
        flex-flow: row wrap;
        align-items: baseline;
        /* Large gap between title and pills, tighter gap between pills. */
        gap: 4px;
        flex: 1 1 auto;
        min-width: 12ch;
    }

    .sp-ai-title {
        font-size: 1.0714em; /* 15px at 14px/em */
        font-weight: 600;
        flex: 0 1 auto;
        overflow-wrap: anywhere;
        margin-right: 8px;
    }

    .sp-ai-kind-badge {
        flex: 0 0 auto;
        font-size: 0.7857em; /* 11px at 14px/em */
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--color-border-zulip-button);
        background-color: var(--color-background-zulip-button);
        position: relative;
        top: -1px;
    }


    .sp-ai-status {
        flex: 0 0 auto;
        font-size: 0.7857em; /* 11px at 14px/em */
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: var(--color-background-widget-button);
        position: relative;
        top: -1px;
    }

    .sp-ai-footer {
        margin-top: 8px;
        display: flex;
        flex-flow: row wrap;
        justify-content: flex-end;
        gap: 8px;
    }

    .sp-ai-btn {
        flex: 0 0 auto;
        height: var(--sp-widget-row-height);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--color-border-dropdown-widget-button);
        border-radius: 8px;
        padding: 0 12px;
        background-color: var(--color-background-widget-button);
        font-weight: 600;
        font-size: 0.857em;
        line-height: 1;
        cursor: pointer;

        &:hover {
            filter: brightness(0.98);
        }
    }

    .sp-ai-btn-approve {
        border-color: color-mix(in srgb, #22c55e 35%, var(--color-border-dropdown-widget-button));
        background-color: color-mix(in srgb, #22c55e 10%, var(--color-background-widget-button));
        color: color-mix(in srgb, #22c55e 70%, var(--color-text-default));
    }

    .sp-ai-btn-deny,
    .sp-ai-btn-abort {
        border-color: color-mix(in srgb, #ef4444 35%, var(--color-border-dropdown-widget-button));
        background-color: color-mix(in srgb, #ef4444 10%, var(--color-background-widget-button));
        color: color-mix(in srgb, #ef4444 70%, var(--color-text-default));
    }

    .sp-ai-btn-retry {
        border-color: color-mix(in srgb, #2563eb 35%, var(--color-border-dropdown-widget-button));
        background-color: color-mix(in srgb, #2563eb 10%, var(--color-background-widget-button));
        color: color-mix(in srgb, #2563eb 70%, var(--color-text-default));
    }

    .sp-ai-icon-btn {
        flex: 0 0 auto;
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--color-border-dropdown-widget-button);
        border-radius: 8px;
        background-color: transparent;
        color: var(--color-text-default);
        opacity: 0.65;
        cursor: pointer;

        &:hover {
            opacity: 0.9;
            background-color: color-mix(in srgb, var(--color-background-widget-button) 55%, transparent);
        }

        &:active {
            transform: translateY(0.5px);
        }
    }

    /* Hover-reveal for copy buttons, but keep them visible on touch devices. */
    .sp-ai-tool-section .sp-ai-icon-btn-copy,
    .sp-ai-block .sp-ai-icon-btn-copy,
    .sp-ai-section summary .sp-ai-icon-btn-copy {
        opacity: 0;
    }

    @media (hover: hover) {
        .sp-ai-tool-section:hover .sp-ai-icon-btn-copy,
        .sp-ai-block:hover .sp-ai-icon-btn-copy,
        .sp-ai-section summary:hover .sp-ai-icon-btn-copy,
        .sp-ai-section summary:focus-within .sp-ai-icon-btn-copy {
            opacity: 0.85;
        }

        .sp-ai-icon-btn-copy:hover {
            opacity: 1;
        }
    }

    @media (hover: none) {
        .sp-ai-icon-btn-copy {
            opacity: 0.85;
        }
    }

    .sp-ai-status-running {
        color: hsl(200deg 79% 30%);
    }

    .sp-ai-status-ok {
        color: hsl(156deg 41% 35%);
    }

    .sp-ai-status-error {
        color: hsl(1deg 45% 45%);
    }

    .sp-ai-status-aborted {
        color: hsl(30deg 32% 40%);
    }

    .sp-ai-status-denied {
        color: hsl(10deg 45% 42%);
    }

    .sp-ai-caption {
        margin-top: 4px;
        color: var(--color-text-default);
        opacity: 0.9;
        overflow-wrap: anywhere;
    }

    .sp-ai-meta {
        margin-top: 6px;
        display: flex;
        flex-flow: row wrap;
        gap: 6px;
        align-items: baseline;
    }

    .sp-ai-meta-key {
        font-weight: 600;
        opacity: 0.8;
    }

    .sp-ai-meta-val {
        font-family: var(--monospace-font);
        overflow-wrap: anywhere;
    }

    .sp-ai-subagent-groups {
        margin-top: 6px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .sp-ai-subagent-group-title {
        font-weight: 600;
        opacity: 0.9;
    }

    .sp-ai-subagent-list {
        margin: 6px 0 0;
        padding: 0;
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .sp-ai-subagent {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        align-items: start;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: var(--color-background-widget-input);
    }

    .sp-ai-subagent-status {
        flex: 0 0 auto;
        font-size: 0.7857em; /* 11px at 14px/em */
        font-weight: 700;
        padding: 2px 8px 2px 18px;
        border-radius: 999px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: var(--color-background-widget-button);
        white-space: nowrap;
        position: relative;
        line-height: 1.4;

        &::before {
            content: "";
            position: absolute;
            left: 7px;
            top: 50%;
            transform: translateY(-50%);
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background-color: currentcolor;
            opacity: 0.7;
        }
    }

    .sp-ai-subagent-status-running {
        color: hsl(200deg 79% 30%);
    }

    .sp-ai-subagent-status-ok {
        color: hsl(156deg 41% 35%);
    }

    .sp-ai-subagent-status-error {
        color: hsl(1deg 45% 45%);
    }

    .sp-ai-subagent-status-unknown {
        color: hsl(0deg 0% 40%);
    }

    .sp-ai-subagent-head {
        display: flex;
        flex-flow: row wrap;
        gap: 6px;
        align-items: baseline;
    }

    .sp-ai-subagent-type {
        font-weight: 700;
        font-family: var(--monospace-font);
        font-size: 0.9285em; /* 13px at 14px/em */
    }

    .sp-ai-subagent-desc {
        opacity: 0.9;
        overflow-wrap: anywhere;
    }

    .sp-ai-subagent-meta {
        margin-top: 2px;
        font-size: 0.8571em; /* 12px at 14px/em */
        opacity: 0.85;
        overflow-wrap: anywhere;
    }

    .sp-ai-subagent-error {
        margin-top: 4px;
        font-size: 0.8571em; /* 12px at 14px/em */
        color: hsl(1deg 45% 45%);
        white-space: pre-wrap;
        overflow-wrap: anywhere;
    }

    .sp-ai-subagent-link {
        align-self: start;
        border: 1px solid var(--color-border-dropdown-widget-button);
        border-radius: 6px;
        padding: 2px 8px;
        background-color: var(--color-background-widget-button);
        font-weight: 600;
        font-size: 0.8571em; /* 12px at 14px/em */
        text-decoration: none;

        &:hover {
            filter: brightness(0.98);
        }
    }

    .sp-ai-background-task-groups {
        margin-top: 6px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .sp-ai-background-task-group-title {
        font-weight: 600;
        opacity: 0.9;
    }

    .sp-ai-background-task-list {
        margin: 6px 0 0;
        padding: 0;
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .sp-ai-background-task {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        align-items: start;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: var(--color-background-widget-input);
    }

    .sp-ai-background-task-status {
        flex: 0 0 auto;
        font-size: 0.7857em; /* 11px at 14px/em */
        font-weight: 700;
        padding: 2px 8px 2px 18px;
        border-radius: 999px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: var(--color-background-widget-button);
        white-space: nowrap;
        position: relative;
        line-height: 1.4;

        &::before {
            content: "";
            position: absolute;
            left: 7px;
            top: 50%;
            transform: translateY(-50%);
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background-color: currentcolor;
            opacity: 0.7;
        }
    }

    .sp-ai-background-task-status-pending {
        color: hsl(220deg 14% 40%);
    }

    .sp-ai-background-task-status-running {
        color: hsl(200deg 79% 30%);
    }

    .sp-ai-background-task-status-ok {
        color: hsl(156deg 41% 35%);
    }

    .sp-ai-background-task-status-error {
        color: hsl(1deg 45% 45%);
    }

    .sp-ai-background-task-status-aborted {
        color: hsl(30deg 32% 40%);
    }

    .sp-ai-background-task-status-unknown {
        color: hsl(0deg 0% 40%);
    }

    .sp-ai-background-task-command {
        font-family: var(--monospace-font);
        font-size: 0.9em;
        line-height: 1.35;
        overflow-wrap: anywhere;
    }

    .sp-ai-background-task-desc {
        margin-top: 2px;
        overflow-wrap: anywhere;
        opacity: 0.9;
    }

    .sp-ai-background-task-meta {
        margin-top: 2px;
        font-size: 0.8571em; /* 12px at 14px/em */
        opacity: 0.85;
        overflow-wrap: anywhere;
    }

    .sp-ai-background-task-error {
        margin-top: 4px;
        font-size: 0.8571em; /* 12px at 14px/em */
        color: hsl(1deg 45% 45%);
        white-space: pre-wrap;
        overflow-wrap: anywhere;
    }

    .sp-ai-background-task-output {
        max-height: 180px;
    }

    .sp-ai-section {
        margin-top: 8px;

        /* Legacy collapsible sections (non-tool turns); kept for now. */

        summary {
            display: flex;
            flex-flow: row wrap;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            cursor: pointer;
        }

        summary .sp-ai-icon-btn {
            width: 28px;
            height: 28px;
        }

        .sp-ai-pre {
            margin-top: 6px;
            padding: 8px;
            border-radius: 6px;
            background-color: var(--color-background-widget-input);
            font-family: var(--monospace-font);
            font-size: 0.9285em; /* 13px at 14px/em */
            line-height: 1.4;
            white-space: pre-wrap;
            overflow-wrap: anywhere;
            max-height: 240px;
            overflow: auto;
        }
    }

    .sp-ai-panel-section {
        margin-top: 6px;
    }

    /* Shared code/markdown presentation (used by both tool + non-tool turns). */
    .sp-ai-tool-section-header {
        display: flex;
        flex-flow: row wrap;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
    }

    .sp-ai-tool-section-title {
        margin: 0;
        font-weight: 600;
        font-size: 0.7857em;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        opacity: 0.75;
    }

    .sp-ai-tool-codewrap {
        margin-top: 4px;
        border-radius: 8px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: color-mix(in srgb, var(--color-background-widget-input) 70%, transparent);
        overflow: hidden;
    }

    .sp-ai-tool-code {
        margin: 0;
        padding: 10px 12px;
        font-family: var(--monospace-font);
        font-size: 0.857em;
        line-height: 1.4;
        white-space: pre-wrap;
        overflow-wrap: anywhere;
        max-height: 320px;
        overflow: auto;
    }

    .sp-ai-block-list {
        margin: 6px 0 0;
        padding: 0;
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .sp-ai-block-list-item {
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: color-mix(in srgb, var(--color-background-widget-input) 60%, transparent);
        font-family: inherit;
        font-size: 0.9em;
        line-height: 1.4;
        white-space: pre-wrap;
        overflow-wrap: anywhere;
    }

    .sp-ai-context-usage {
        margin-top: 6px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .sp-ai-context-usage-bar {
        height: 10px;
        border-radius: 999px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: color-mix(in srgb, var(--color-background-widget-input) 70%, transparent);
        overflow: hidden;
    }

    .sp-ai-context-usage-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #22c55e 0%, #f59e0b 60%, #ef4444 100%);
        opacity: 0.85;
    }

    .sp-ai-context-usage-summary {
        font-size: 0.857em;
        opacity: 0.85;
    }

    &[data-sp-ai-status="error"] .sp-ai-panel-section:last-of-type .sp-ai-tool-codewrap,
    &[data-sp-ai-status="denied"] .sp-ai-panel-section:last-of-type .sp-ai-tool-codewrap {
        border-color: color-mix(in srgb, #ef4444 25%, var(--color-border-dropdown-widget-button));
        background-color: color-mix(in srgb, #ef4444 8%, var(--color-background-widget-input));
    }

    &[data-sp-ai-status="error"] .sp-ai-panel-section:last-of-type .sp-ai-tool-code,
    &[data-sp-ai-status="denied"] .sp-ai-panel-section:last-of-type .sp-ai-tool-code {
        color: color-mix(in srgb, #ef4444 70%, var(--color-text-default));
    }

    .sp-ai-blocks {
        margin-top: 6px;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 7px;
    }

    .sp-ai-block {
        border: 1px solid var(--color-border-zulip-button);
        border-radius: 6px;
        background-color: var(--color-background-zulip-button);
        padding: 7px;
    }

    .sp-ai-block-stream-stdout {
        border-left: 3px solid hsl(156deg 28% 60%);
        padding-left: 7px;
    }

    .sp-ai-block-stream-stderr {
        border-left: 3px solid hsl(1deg 45% 58%);
        padding-left: 7px;
    }

    .sp-ai-block-unknown {
        border-style: dashed;
    }

    .sp-ai-block-header {
        display: flex;
        flex-flow: row wrap;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
    }


    .sp-ai-block-meta {
        display: flex;
        flex-flow: row wrap;
        align-items: baseline;
        gap: 6px;
        min-width: 12ch;
        flex: 1 1 auto;
    }

    .sp-ai-block-badge {
        flex: 0 0 auto;
        font-size: 0.7857em;
        font-weight: 700;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        color: var(--color-text-default);
        opacity: 0.8;
    }

    .sp-ai-block-title {
        overflow-wrap: anywhere;
    }


    .sp-ai-table-wrap {
        margin-top: 6px;
        overflow-x: auto;
    }

    .sp-ai-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9285em; /* 13px at 14px/em */

        th,
        td {
            border: 1px solid var(--color-border-widget-form-control);
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
            overflow-wrap: anywhere;
        }

        th {
            background-color: var(--color-background-widget-button);
            font-weight: 600;
        }
    }

    @media (max-width: 480px) {

        .sp-ai-status,
        .sp-ai-kind-badge {
            font-size: 0.75em;
        }

        .sp-ai-btn {
            font-size: 0.8em;
        }
    }
}

/*
 * Reasoning / thinking turn — inspired by Vercel AI Elements <Reasoning>.
 * No card, no chrome. Just an inline trigger + collapsible text.
 */
.sp-ai-reasoning {
    /* No border, no background — sits inline in the message. */

    .sp-ai-reasoning-trigger {
        all: unset;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        color: var(--color-text-default);
        opacity: 0.6;
        font-size: 0.9285em; /* ~13px */
        line-height: 1.4;
        transition: opacity 120ms ease;

        &:hover,
        &:focus-visible {
            opacity: 0.9;
        }

        &[aria-expanded="true"] .sp-ai-reasoning-chevron {
            transform: rotate(180deg);
        }
    }

    .sp-ai-reasoning-icon {
        flex: 0 0 auto;
        opacity: 0.8;
    }

    .sp-ai-reasoning-chevron {
        flex: 0 0 auto;
        opacity: 0.55;
        transition: transform 150ms ease;
    }

    .sp-ai-reasoning-label {
        flex: 0 1 auto;
    }

    /* Shimmer animation for "Thinking..." while streaming. */
    &[data-sp-ai-status="running"] .sp-ai-reasoning-label {
        background: linear-gradient(
            90deg,
            var(--color-text-default) 0%,
            var(--color-text-default) 40%,
            color-mix(in srgb, var(--color-text-default) 40%, transparent) 50%,
            var(--color-text-default) 60%,
            var(--color-text-default) 100%
        );
        background-size: 250% 100%;
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        animation: sp-ai-shimmer 2s linear infinite;
    }

    @keyframes sp-ai-shimmer {
        0% { background-position: 100% center; }
        100% { background-position: 0% center; }
    }

    /* Collapsible content area. */
    .sp-ai-reasoning-content {
        overflow: visible;
        max-height: 0;
        opacity: 0;
        transition: max-height 200ms ease, opacity 150ms ease, margin 150ms ease;
        margin-top: 0;
    }

    .sp-ai-reasoning-content[aria-hidden="false"] {
        max-height: 2000px; /* generous upper bound; collapses to content */
        opacity: 1;
        margin-top: 8px;
    }

    .sp-ai-reasoning-text {
        color: var(--color-text-default);
        opacity: 0.6;
        font-size: 0.9285em; /* ~13px */
        line-height: 1.55;
        white-space: pre-wrap;
        overflow-wrap: anywhere;
    }
}

/*
 * POC: Tool turn styling inspired directly by Vercel AI elements (Tool header + collapsible content).
 * Scope tightly to the tool wrapper so we can iterate without perturbing other turn kinds.
 */
.sp-ai-tool {
    padding: 0;
    /* Tool widgets manage their internal spacing; outer padding should be 0. */
    --sp-ai-pad-y: 0px;

    border-radius: 10px;
    overflow: hidden;

    /* Re-add linkage bands for parallel tool widgets (the base `.sp-ai-tool { padding: 0; }`
       would otherwise erase the extra top/bottom padding from `.sp-ai-widget.sp-ai-parallel`). */
    &.sp-ai-parallel:not(.sp-ai-parallel-first) {
        padding-top: var(--sp-ai-link-band);
    }

    &.sp-ai-parallel:not(.sp-ai-parallel-last) {
        padding-bottom: var(--sp-ai-link-band);
    }

    /* Preserve existing parallel padding behavior. */
    &.sp-ai-parallel {
        padding-left: 0;
    }

    summary.sp-ai-tool-summary {
        list-style: none;
        display: flex;
        flex-flow: row wrap;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 12px;
        cursor: pointer;

        &::-webkit-details-marker {
            display: none;
        }
    }

    .sp-ai-tool-summary-left {
        display: flex;
        flex-flow: row wrap;
        align-items: center;
        gap: 8px;
        min-width: 12ch;
        flex: 1 1 auto;
    }

    .sp-ai-tool-icon {
        color: var(--color-text-default);
        opacity: 0.65;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
        top: -1px;
    }

    .sp-ai-tool-name {
        font-weight: 600;
        font-size: 0.95em;
        overflow-wrap: anywhere;
    }

    .sp-ai-tool-status {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 2px 8px 2px 6px;
        border-radius: 999px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: var(--color-background-widget-button);
        font-size: 0.7857em;
        font-weight: 500;
        line-height: 1.35;
        position: relative;
        top: -1px;
    }

    .sp-ai-tool-status-icon {
        display: none;
        align-items: center;
        justify-content: center;
    }

    &[data-sp-ai-status="pending"] .sp-ai-tool-status-icon-pending { display: inline-flex; }
    &[data-sp-ai-status="running"] .sp-ai-tool-status-icon-running { display: inline-flex; }
    &[data-sp-ai-status="approval_requested"] .sp-ai-tool-status-icon-approval-requested { display: inline-flex; }
    &[data-sp-ai-status="approval_responded"] .sp-ai-tool-status-icon-approval-responded { display: inline-flex; }
    &[data-sp-ai-status="ok"] .sp-ai-tool-status-icon-ok { display: inline-flex; }
    &[data-sp-ai-status="error"] .sp-ai-tool-status-icon-error { display: inline-flex; }
    &[data-sp-ai-status="aborted"] .sp-ai-tool-status-icon-aborted { display: inline-flex; }
    &[data-sp-ai-status="denied"] .sp-ai-tool-status-icon-denied { display: inline-flex; }

    /* Status-specific icon colors matching AI Elements. */
    &[data-sp-ai-status="running"] .sp-ai-tool-status-icon-running {
        animation: sp-ai-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    &[data-sp-ai-status="approval_requested"] .sp-ai-tool-status-icon-approval-requested { color: #ca8a04; }
    &[data-sp-ai-status="approval_responded"] .sp-ai-tool-status-icon-approval-responded { color: #2563eb; }
    &[data-sp-ai-status="ok"] .sp-ai-tool-status-icon-ok { color: #22c55e; }
    &[data-sp-ai-status="error"] .sp-ai-tool-status-icon-error { color: #ef4444; }
    &[data-sp-ai-status="aborted"] .sp-ai-tool-status-icon-aborted { color: #f97316; }
    &[data-sp-ai-status="denied"] .sp-ai-tool-status-icon-denied { color: #f97316; }

    /* Status text color to match icon. */
    &[data-sp-ai-status="approval_requested"] .sp-ai-tool-status-text { color: #ca8a04; }
    &[data-sp-ai-status="approval_responded"] .sp-ai-tool-status-text { color: #2563eb; }
    &[data-sp-ai-status="ok"] .sp-ai-tool-status-text { color: #22c55e; }
    &[data-sp-ai-status="error"] .sp-ai-tool-status-text { color: #ef4444; }
    &[data-sp-ai-status="aborted"] .sp-ai-tool-status-text { color: #f97316; }
    &[data-sp-ai-status="denied"] .sp-ai-tool-status-text { color: #f97316; }

    @keyframes sp-ai-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    .sp-ai-tool-summary-right {
        display: flex;
        flex-flow: row wrap;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
        flex: 0 0 auto;
    }

    .sp-ai-tool-chevron {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text-default);
        opacity: 0.55;
        transition: transform 120ms ease;
    }

    &[open] .sp-ai-tool-chevron {
        transform: rotate(180deg);
    }

    .sp-ai-tool-content {
        padding: 12px 14px 14px;
        border-top: 1px solid var(--color-border-dropdown-widget-button);
    }


    .sp-ai-tool-sections {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .sp-ai-tool-section-header {
        display: flex;
        flex-flow: row wrap;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
    }

    .sp-ai-tool-section-title {
        margin: 0;
        font-weight: 600;
        font-size: 0.7857em;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        opacity: 0.75;
    }

    .sp-ai-tool-codewrap {
        margin-top: 6px;
        border-radius: 8px;
        border: 1px solid var(--color-border-dropdown-widget-button);
        background-color: color-mix(in srgb, var(--color-background-widget-input) 70%, transparent);
        overflow: hidden;
    }

    .sp-ai-tool-code {
        margin: 0;
        padding: 10px 12px;
        font-family: var(--monospace-font);
        font-size: 0.857em;
        line-height: 1.4;
        white-space: pre-wrap;
        overflow-wrap: anywhere;
        max-height: 320px;
        overflow: auto;
    }


    /* Error / denied sections: red-tinted background like AI Elements destructive/10. */
    .sp-ai-tool-section-stream-stderr .sp-ai-tool-codewrap,
    &[data-sp-ai-status="error"] .sp-ai-tool-section:last-child .sp-ai-tool-codewrap,
    &[data-sp-ai-status="denied"] .sp-ai-tool-section:last-child .sp-ai-tool-codewrap {
        border-color: color-mix(in srgb, #ef4444 25%, var(--color-border-dropdown-widget-button));
        background-color: color-mix(in srgb, #ef4444 8%, var(--color-background-widget-input));
    }

    &[data-sp-ai-status="error"] .sp-ai-tool-section:last-child .sp-ai-tool-code,
    &[data-sp-ai-status="denied"] .sp-ai-tool-section:last-child .sp-ai-tool-code {
        color: color-mix(in srgb, #ef4444 70%, var(--color-text-default));
    }

    @media (max-width: 480px) {
        summary.sp-ai-tool-summary {
            padding: 10px;
        }

        .sp-ai-tool-content {
            padding: 10px 10px 12px;
        }

        .sp-ai-tool-name {
            font-size: 0.9em;
        }
    }
}

.todo-widget {
    .todo-task-list-title-bar {
        flex: 1 1 auto;
        display: flex;
        /* Ensure controls remain visible on narrower screens. */
        flex-flow: row wrap;
        gap: 5px;
        margin-bottom: var(--markdown-interelement-space-px);
    }

    .add-task-bar {
        display: flex;
        /* Ensure controls remain visible on narrower screens. */
        flex-flow: row wrap;
        gap: 5px;
    }

    /* For the box-shadow to be visible on the left */
    .add-task,
    .add-desc {
        font-weight: 400;
    }

    & label.checkbox {
        display: flex; /* Arrange that a multi-line description line wraps properly. */
        /* Keep checkboxes vertically aligned, including with multi-line tasks. */
        align-items: baseline;
        /* Reset default label.checkbox styles. */
        gap: 5px;
        position: static;
        min-height: 0;

        & input[type="checkbox"] {
            ~ .custom-checkbox {
                display: inline-block;
                vertical-align: middle;
                position: static;

                padding: 2px;
                margin: 0;

                font-size: 1.3em; /* 18.2px / 14px em */
                height: 0.6593em; /* 12px at 18.2px / em */
                width: 0.6593em; /* 12px at 18.2px / em */

                font-weight: 300;
                line-height: 0.8;
                text-align: center;
                border: 2px solid var(--color-border-todo-checkbox);

                border-radius: 4px;
                filter: brightness(1);

                cursor: pointer;
            }

            &:checked ~ .custom-checkbox {
                background-image: url("../images/checkbox-white.svg");
                background-size: 75%;
                background-position: 50% 50%;
                background-repeat: no-repeat;
                background-color: var(--color-background-todo-checkbox-checked);
                border-color: var(--color-border-todo-checkbox-checked);
            }

            &:disabled ~ .custom-checkbox {
                opacity: 0.5;
                cursor: not-allowed;
            }

            &:hover ~ .custom-checkbox {
                border-color: var(--color-border-todo-checkbox-hover);
            }

            &:not(:checked):hover ~ .custom-checkbox {
                /* We only change the background color on hover,
                   when the checkbox is not checked. */
                background-color: var(--color-background-todo-checkbox-hover);
            }

            &:focus ~ .custom-checkbox {
                outline-color: hsl(0deg 0% 100% / 0%);
            }
        }
    }
}

/* Poll/Todo widgets restyled as cards (when sp-widget-card is present). */
.sp-widget-card.poll-widget,
.sp-widget-card.todo-widget {
    padding: 8px 10px;
}

.sp-widget-card.poll-widget .poll-question-header,
.sp-widget-card.todo-widget .todo-task-list-title-header {
    margin: 0;
}

.sp-widget-card.poll-widget input[type="text"],
.sp-widget-card.todo-widget input[type="text"] {
    flex: 1 1 auto;
    min-width: 14ch;
    height: var(--sp-widget-row-height);
    box-sizing: border-box;
    border: 1px solid var(--color-border-dropdown-widget-button);
    box-shadow: none;
    border-radius: 8px;
    color: var(--color-text-default);
    background-color: var(--color-background-widget-input);
    padding: 0 12px;
    font-size: 0.95em;

    &::placeholder {
        opacity: 0.65;
    }

    &:focus {
        border-color: var(--color-border-dropdown-widget-button);
        outline: 0;
        box-shadow: none;
        background-color: var(--color-background-widget-input);
    }
}

.sp-widget-card.poll-widget .poll-question-bar,
.sp-widget-card.todo-widget .todo-task-list-title-bar {
    margin-top: 8px;
    margin-bottom: 8px;
    margin-right: 0;
    display: flex;
    flex-flow: row wrap;
    align-items: center;
    gap: 6px;
}

.sp-widget-card.poll-widget .poll-option-bar,
.sp-widget-card.todo-widget .add-task-bar {
    margin-top: 8px;
    display: flex;
    flex-flow: row wrap;
    align-items: center;
    gap: 8px;
}

.sp-widget-card.poll-widget button.poll-option,
.sp-widget-card.todo-widget button.add-task {
    height: var(--sp-widget-row-height);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border-dropdown-widget-button);
    border-radius: 8px;
    padding: 0 12px;
    background-color: var(--color-background-widget-button);
    color: var(--color-text-default);
    font-weight: 700;
    font-size: 0.857em;
    line-height: 1;
    cursor: pointer;

    &:hover {
        filter: brightness(0.98);
    }

    &:active {
        transform: translateY(0.5px);
    }
}

.todo-widget,
.poll-widget {
    .poll-question-header:not(.sp-widget-title),
    .todo-task-list-title-header:not(.sp-widget-title) {
        font-size: 1.1em;
        font-weight: 600;
    }

    & li {
        display: flex;
        gap: 5px;
        align-items: baseline;
        list-style: none;
        margin: 0 0 5px;
    }

    & ul {
        margin: 0 0 5px;
        padding: 0;
    }

    & input[type="text"] {
        /* Reset from zulip.css */
        height: unset;
        border: 1px solid hsl(0deg 0% 80%);
        box-shadow: inset 0 1px 1px hsl(0deg 0% 0% / 7.5%);
        border-radius: 4px;
        color: var(--color-text-default);

        &:focus {
            border-color: hsl(206deg 80% 62% / 80%);
            outline: 0;
            box-shadow: none;
            background-color: var(--color-background-widget-input);
            transition:
                border-color linear 0.2s,
                box-shadow linear 0.2s;
        }
    }
}

.poll-widget {
    .poll-option-bar {
        display: flex;
        /* Ensure controls remain visible on narrower screens. */
        flex-flow: row wrap;
        gap: 5px;
    }

    .poll-option {
        font-weight: 400;
    }

    .poll-option-label {
        display: flex;
        gap: 5px;
        align-items: baseline;
    }

    .poll-option-text {
        font-weight: 600;
        /* Start with max-content, but allow options
           to shrink, so that voting names wrap comfortably. */
        flex: 0 1 max-content;
    }

    .poll-vote {
        color: var(--color-poll-vote);
        border-color: var(--color-border-poll-vote);
        border-style: solid;
        font-weight: 600;
        border-radius: 3px;
        /* We don't want poll-vote tallies to spill
           digits onto second lines in narrow viewports. */
        flex-shrink: 0;
        min-width: 1.7857em; /* 25px at 14px / em */
        height: 1.7857em; /* 25px at 14px / em */
        font-size: 0.9285em; /* 13px at 14px / em */
        background-color: var(--color-background-widget-button);

        &:hover {
            color: var(--color-poll-vote-hover);
            background-color: var(--color-background-poll-vote-hover);
            border-color: var(--color-border-poll-vote-hover);
        }

        &:focus {
            outline: 0;
            color: var(--color-poll-vote-focus);
            background-color: var(--color-background-poll-vote-focus);
            border-color: var(--color-border-poll-vote-focus);
        }

        &:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    }

    .poll-names {
        color: var(--color-poll-names);
        /* Aim for 50% of the flexbox for voting names,
           but also shrink modestly (.5) adjacent a long
           option. */
        flex: 1 0.5 50%;
    }
}

button {
    &.task {
        height: 20px;
        width: 20px;
        background-color: transparent;
        border-color: hsl(156deg 28% 70%);
        margin-right: 4px;
        border-radius: 3px;

        &:hover {
            border: 1px solid hsl(194deg 60% 40%);
        }
    }

    &.add-task,
    &.poll-option {
        color: hsl(156deg 41% 40%);
        border: 1px solid hsl(156deg 28% 70%);
        width: max-content;
        flex: 0 0 auto;
        border-radius: 3px;
        background-color: var(--color-background-widget-button);
        padding: 4px;
        padding-left: 14px;
        padding-right: 14px;

        &:hover,
        &:focus {
            outline: 0;
            border-color: hsl(156deg 30% 50%);
            transition: 0.2s ease;
            transition-property: background-color, border-color, color;
        }

        &:active {
            transition: 0.2s ease;
            transition-property: background-color, border-color, color;
        }

        &:disabled {
            cursor: not-allowed;
            filter: saturate(0);
            background-color: var(--color-background-zulip-button-disabled);
            color: hsl(0deg 3% 52%);
        }
    }
}

input {
    &.add-task,
    &.add-desc,
    &.poll-option,
    &.poll-question,
    &.todo-task-list-title {
        flex: 1 0 auto;
        padding: var(--input-vertical-padding) var(--input-horizontal-padding);
    }
}

.widget-error {
    color: hsl(1deg 45% 50%);
    font-size: 0.8571em; /* 12px at 14px/em */
    display: flex;
    align-items: center;
}

button.poll-question-check:not(.sp-widget-icon-btn),
button.poll-question-remove:not(.sp-widget-icon-btn),
button.todo-task-list-title-check:not(.sp-widget-icon-btn),
button.todo-task-list-title-remove:not(.sp-widget-icon-btn) {
    align-self: stretch;
    /* TODO: Re-express the 30.5px value here
       as part of information density work. */
    flex: 0 0 30.5px;
    min-height: 30.5px;
    border-radius: 3px;
    border: 1px solid var(--color-border-zulip-button);
    background-color: var(--color-background-zulip-button);

    &:hover {
        border-color: var(--color-border-zulip-button-interactive);
        background-color: var(--color-background-zulip-button-hover);
    }
}

i.poll-edit-question,
i.todo-edit-task-list-title {
    color: var(--color-message-action-visible);

    &:hover,
    &:focus-visible {
        color: var(--color-message-action-interactive);
    }
}

.poll-question-bar {
    flex: 1 1 auto;
    display: flex;
    /* Ensure controls remain visible on narrower screens. */
    flex-flow: row wrap;
    gap: 5px;
    /* Reserve space for the focus outline to prevent it from being cut off */
    margin-right: 2px;
    margin-bottom: var(--markdown-interelement-space-px);
}

.poll-widget-header-area:not(.sp-widget-header),
.todo-widget-header-area:not(.sp-widget-header) {
    display: flex;
    align-items: baseline;
    gap: 5px;
}

.current-user-vote {
    background-color: hsl(156deg 10% 90% / 90%);
}

.add-task-wrapper {
    display: inline;
    position: relative;
    z-index: 1;

    /* Unlike other browsers like Chrome, Microsoft Edge, etc.,
    Firefox does not automatically display the "not-allowed"
    cursor for disabled elements. The below css ensures that the
    correct cursor is shown across all browsers. */
    &:hover {
        cursor: not-allowed;
    }
}
